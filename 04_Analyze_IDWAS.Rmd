---
title: "Analyze IDWAS Results"
output: html_notebook
---

Now that we have a drug list, we can identify what pathways these drugs target. The list indicates that cell cycle is the most prominent pathway targeted. 

#need to load data from Analyze_TCGA-Imputation-Data as well as the currently non-existant Impute_All_TCGA_for_IDWAS.Rmd and IDWAS_Workflow.Rmd


We can go further and use the entire TCGA patient data and find associations between genetic features (i.e. non-synonymous mutations) and the patient's Imputed Sensitivty Scores. If we graph the 9 genes with the most significant values, this is the result.  


```{r Biomarker Analysis}

library(tidyverse)
theme_set(theme_bw())
TCGA_BRCA_muts_idwa <- read_csv("E:/Research/a) General-methods_Imputations_Biomarkers/b) IDWAS and Biomarkers/IDWAS/tables/CTRPResults_BRCAonly.csv")

IDWAS_results <-  TCGA_BRCA_muts_idwa %>% 
  separate(col = X1, into = c("Drug", "Gene"), sep = "\\.") %>% 
  rename(FDR = `FDR (BH corrected)`) %>% 
  mutate(logFDR = -log10(FDR))

IDWAS_results
```

```{r Drug Based Analysis}
azd_p53<- IDWAS_results %>% 
  filter(Drug == "MK-1775") %>% 
  ggplot(aes(x = logFDR)) + 
    geom_histogram(bins = 20, fill = "light blue", color = "black") +
    labs(y = "Number of Associations", 
         x = "Significance (-log10 FDR)") +
    xlim(NA, 48) +
  geom_vline(xintercept = 45.9, color = "red") +
  annotate(geom = "text", x = 34, y = 200, parse = T, 
           label = as.character(expression(atop("p53-AZD1775 Association", "(red line, FDR = 1.2x10"^{-46}*")"))))

azd_p53


```


```{r Gene-Based Analysis}
biomarker_eta.sq <- TCGA_muts_idwa %>% 
  separate(col = X1, into = c("Drug", "Gene"), sep = "\\.") %>% 
  right_join(., targets_eta.sq, by = "Drug") %>% 
  filter(.$Gene %in% unique(.$Gene[.$`FDR (BH corrected)` < 0.0005])) 

biomarker_eta.sq %>% 
  filter(`FDR (BH corrected)` < 0.01) %>% 
  arrange(`FDR (BH corrected)`)

biomarker_eta.sq %>% 
  ggplot(mapping = aes(x = `Effect Size (beta)`, y = -log(`FDR (BH corrected)`), label = Drug)) + 
    geom_point() + 
    facet_wrap(~Gene, scales = "free_y") +
    geom_vline(xintercept = 0, color = "black", linetype = "dashed") + 
    geom_hline(yintercept = -log(0.01), color = "red") + 
    labs(title = "Top Mutation-Imputed-Drug Associations in TCGA",
         y = "-log(FDR)") + 
    theme(plot.title = element_text(hjust = 0.5))


top_gene.drug_associations_table <- biomarker_eta.sq %>% 
  select(Drug, Gene, `FDR (BH corrected)`) %>% 
  spread(key = Gene, value = `FDR (BH corrected)`)

top_gene.drug_associations_table
```

As we can see, even though all drugs are predicted to be more sensitive in TCGA TNBC patients, we can see that there are a variety of gene-drug associations. Some are highly specific, such as NFE2L2 with NSC-74859, 

We can look at the FDR corrected p-values for all the mutation-drug associations in the following table (each value in this table is an FDR corrected p-value for the respective gene and drug)

