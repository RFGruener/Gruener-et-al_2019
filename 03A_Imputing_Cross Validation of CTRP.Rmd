---
title: 'Imputations: Build models using the CCLE/CTRPv2 datasets to impute drug response in TCGA BRCA Tumors'
output: html_notebook 
author:
  - "Robert F. Gruener"
date: "date last edited: `r format(Sys.time(), '%d %B, %Y')`"
---

### Objectives

Do the imputations

 * Set the parameters
 * Load the test expression data (TCGA Breast Cancer)
 * Load the CTRP/CCLE Training expression and drug data
 * Run the cross-validation 

Important: Set the parameters appropriately, then everything else *should* run smoothly if you run the enitre file. 

```{r, include=FALSE}
knitr::opts_chunk$set(echo = T, results = "hide", message = "hide")
```

### First, load packages and set parameters

The necessary packages and files should have been download in file 01_Downlaod

```{r loading packages and setting parameters, results= "hide"}
set.seed(12345)
#Loading Packages
needed_packages <- c("tidyverse", "readxl", "glmnet", "gdata", "illuminaHumanv4.db" ,"car", "ridge", "preprocessCore", "genefilter", "sva", "pRRophetic")
lapply(needed_packages, require, character.only = TRUE)

# library(doParallel), could easily be made to run in parallel

```

### Second, load the RNA-Seq data

```{r Load RNA-Seq}
############ Load Test Expression data (as Matrix) ###################

# load  the breast cancer RNA-seq file downloaded previously
tpmDatMat <- read.delim(file = "./DataIn/TCGA/RNA-seq/BRCA.rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes__data.data.txt", as.is=T)
tpmDatMat_tpm <- tpmDatMat[-1,which(tpmDatMat[1,] == "scaled_estimate")]
tpmDatMat_tpm <- apply(tpmDatMat_tpm, 2, as.numeric)
geneNames <- do.call(cbind, strsplit(tpmDatMat[, "Hybridization.REF"], "|", fixed=TRUE))[1,][-1]
rownames(tpmDatMat_tpm) <- geneNames
colnames(tpmDatMat_tpm) <- substr(colnames(tpmDatMat_tpm), 1, 28)
tpmDatMat_tpm_logged <- log((tpmDatMat_tpm*1000000)+1) # transform the data
#remove adjacent normal RNA-seq samples
testExprData <- tpmDatMat_tpm_logged[,-grep(pattern = ".11A.|.11B.|.10A.|.10B.", colnames(tpmDatMat_tpm_logged))]

```

### Third, load and clean the CTRP/CCLE data:

Perform imputations using CTRP/CCLE datasets as the training dataset

```{r CTRP Imputations, message = FALSE}

#Loads training phenotype data 
CTRPv2_AUC <- read.delim("./DataIn/CTRPv2/CTRPv2_AUC_clean.txt", sep = "\t", stringsAsFactors = F)
#Altering cell line names that start with a number to start with an X to match rownames of expression data
start.with.number <- grep("^[[:digit:]]", CTRPv2_AUC$CCL_Name)
CTRPv2_AUC$CCL_Name[start.with.number] <- paste("X", CTRPv2_AUC$CCL_Name[start.with.number], sep = "")
trainingPhenData <- CTRPv2_AUC
#names(trainingPhenData)[names(trainingPhenData)== "cpd_name"] <- "Drug.name"
possibleDrugs <- unique(trainingPhenData$cpd_name)

#Load Training Expression data, convert it to a matrix
CTRPv2_RNAseq_TPM <- read.delim("./DataIn/CTRPv2/CTRPv2_RNAseq_TPM_clean.txt",  sep = "\t", stringsAsFactors = F)
convert.to.matrix <- function(df){
  mat <- as.matrix(df[,-1])
  rownames(mat) <- c(t(df[,1]))
  return(mat)
  }
ExprData <- convert.to.matrix(CTRPv2_RNAseq_TPM)



```

### Fourth, do cross-validation


Note for the cross-validation. It takes up a lot of memory, especially if you don't subset the genes. There are 17,000 genes that overlap between training and the test data, but if you j ust use the training data there are 50,000+ genes which usually (on a base computer) will run into a protect() stack overflow error. For running the LOOCV with all the cell lines (for MK-1775, all 762 of them), you will likely run into an error of the vector being too large (6 GB) to store. 


### A more efficient CV

```{r}

#free up some memory 
rm(list = keep(trainingPhenData, ExprData, testExprData, mk1775))

possibleDrugs <- unique(trainingPhenData$cpd_name)

corP_spear <- numeric()
cor_spear <- numeric()
corP_pearson <- numeric()
cor_pearson <- numeric()
RMSEs <- numeric()
nAll <- numeric()

rmse <- function(error){
  sqrt(mean(error^2, na.rm = T))
}


########make a for loop for each drug seperate#################
for(i in 1:length(possibleDrugs)) { 
  drug <- possibleDrugs[i]
  temp <- trainingPhenData[trainingPhenData$cpd_name == drug,] ## Makes temp matrix to extract the AUCs easier
  AUCs <- as.numeric(temp$Avg_AUC)
  names(AUCs) <- temp$CCL_Name
  AUCs <- AUCs
  commonCellLines <- colnames(ExprData)[colnames(ExprData) %in% names(AUCs)]
  AUCsOrd <- AUCs[commonCellLines]
  trainDataOrd <- ExprData[, commonCellLines]
  trainDataOrd <- trainDataOrd[(rowSums(trainDataOrd) != 0), ]
  CTRP_LOOCV <- predictionAccuracyByCv(trainingExprData =  trainDataOrd, trainingPtype = AUCsOrd, testExprData = testExprData, cvFold = 20)
  # correlations on all tumors.
    spearCor <- cor.test(CTRP_LOOCV[[1]], CTRP_LOOCV[[2]], method = "spearman")
    corP_spear[i] <- spearCor$p.value
    cor_spear[i] <- spearCor$estimate
    
    nAll[i] <- length(CTRP_LOOCV[[1]])
    
    pearson_Cor <- cor.test(CTRP_LOOCV[[1]], CTRP_LOOCV[[2]], method = "pearson")
    corP_pearson[i] <- pearson_Cor$p.value
    cor_pearson[i] <- pearson_Cor$estimate
    error <- CTRP_LOOCV[[1]] - CTRP_LOOCV[[2]]
    RMSEs[i] <- rmse(error)

  
} #close for loop

m <- cbind(possibleDrugs, nAll, RMSEs, cor_spear, corP_spear, cor_pearson, corP_pearson)
colnames(m) <- c("Drug", "N_CCLs","RMSE", "Spearman_Correlation" , "Spearman_Pvalue", "Pearson_Correlation", "Pearson_Pvalue")

write.csv(m, file = "./DataOut/20FoldCV_CTRP.csv")
```


```{r CV analysis}
cv <- as_tibble(m) %>% type_convert()

CTRP_5CV <- read.delim(file = "E:/Research_Repos/1_git_repos/pRRophetic_plus/b_scripts-and-results/03_Model_testing_CV/Getting-good-predictions/CV_vs_AvgAUC/b. data_in/CTRPv2_RNAseq-TPM_5fold-CV.txt", sep = "\t")

cv %>% 
  ggplot(aes(x = Spearman_Correlation)) + 
  geom_histogram()

CTRP_5CV %>% 
  ggplot(aes(x = Spearman_Cor)) + 
  geom_histogram()

left_join(cv, CTRP_5CV, by = c("Drug" = "Compound")) %>% 
  ggplot(aes(x = Spearman_Correlation, y = Spearman_Cor)) +
  geom_point() + 
  geom_abline(slope = 1)

#as we can tell, there isn't really any difference between this and the old results

```


```{r cv and ncells}

cv %>% 
  ggplot(aes(x = N_CCLs, y = Spearman_Correlation)) +
  geom_point() + 
  theme_bw()

cv %>% 
  ggplot(aes(x = N_CCLs, y = Pearson_Correlation)) +
  geom_point() + 
  theme_bw()

```
 
Not quite what I expected

```{r cv cutoff}

cv %>% 
  mutate(log10SpearP = log10(Spearman_Pvalue)) %>% 
  ggplot(aes(x = -log10SpearP)) + 
    geom_histogram() + 
    geom_vline(xintercept = -log10(0.05))
  
cv %>% 
  mutate(FDR_Spearman = p.adjust(p = Spearman_Pvalue, method = "fdr")) %>% 
  mutate(log10FDR_SpearmanP = log10(FDR_Spearman)) %>% 
  ggplot(aes(x = -log10FDR_SpearmanP)) + 
    geom_histogram() + 
    geom_vline(xintercept = -log10(0.05), color = "red")

cv %>% 
  count(Spearman_Pvalue < 0.05)

cv %>% 
  mutate(FDR_Spearman = p.adjust(p = Spearman_Pvalue, method = "fdr")) %>% 
  count(FDR_Spearman < 0.05 )

cv %>% 
  mutate(FDR_Spearman = p.adjust(p = Spearman_Pvalue, method = "bonferroni")) %>% 
  mutate(log10FDR_SpearmanP = -log10(FDR_Spearman)) %>% 
  ggplot(aes(y = log10FDR_SpearmanP, x = Spearman_Correlation)) + 
    geom_point() + 
    geom_hline(yintercept = -log10(0.00001))

cv %>% 
  ggplot(aes(x = Spearman_Correlation, y = Pearson_Correlation)) +
  geom_point() + 
  geom_hline(yintercept = 0.25) + 
  geom_vline(xintercept = 0.25)

cv %>% 
  ggplot(aes(x = log10(Spearman_Pvalue), y = log10(Pearson_Pvalue))) +
  geom_point() 

temp <- cv %>% 
  filter(Spearman_Correlation > 0.1, 
         Pearson_Correlation > 0.1, 
         Pearson_Pvalue < 0.01, 
         Spearman_Pvalue < 0.01)

  
```

```{r}
print(sessionInfo())
```