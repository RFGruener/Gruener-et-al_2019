---
title: "Analyzing TCGA (patient) Imputation Data"
output: html_notebook
---

Analysis outline: 

  * Install TCGAbiolinks to get TCGA clinical data
  * Format BRCA predictions, merge with clinical data
  * Perform t-tests and correct for multiple testing 
  * Graph results for AZD-1775
  

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```


```{r install packages, include= FALSE}

if (!requireNamespace("TCGAbiolinks", quietly = TRUE))
    BiocManager::install("TCGAbiolinks")

if (!requireNamespace(c("broom", "grid", "ggrepel", "lsr"), quietly = TRUE))
    install.packages("broom", "grid", "ggrepel", "lsr")

library(TCGAbiolinks)
library(tidyverse)
library(broom)
library(readxl)
library(grid)
library(ggrepel)

theme_set(theme_bw())

```



```{r download TCGA clinical data}
query <- GDCquery(project = "TCGA-BRCA", 
                  data.category = "Clinical",
                  data.type = "Clinical Supplement", 
                  data.format = "BCR Biotab")
GDCdownload(query)
clinical.BCRtab.all <- GDCprepare(query)
names(clinical.BCRtab.all)
BRCA_clinical <- clinical.BCRtab.all$clinical_patient_brca %>%
    dplyr::select(bcr_patient_barcode, er_status_by_ihc, er_status_ihc_Percent_Positive, pr_status_by_ihc, 
                  pr_status_ihc_percent_positive, her2_status_by_ihc, her2_fish_status, ) %>%
    dplyr::slice(-1:-2) %>% 
    type_convert() %>% 
    mutate(HER2_Subtype = if_else(condition = her2_fish_status %in% c("Positive", "Negative"), her2_fish_status, her2_status_by_ihc)) %>% 
    filter(er_status_by_ihc %in% c("Positive", "Negative"), 
           pr_status_by_ihc %in% c("Positive", "Negative"), 
           HER2_Subtype %in% c("Positive", "Negative")) %>% 
    mutate(Clin_Subtype = if_else(condition = er_status_by_ihc == "Positive" | pr_status_by_ihc == "Positive", 
                                  true = if_else(condition = HER2_Subtype == "Positive", true = "ER/PR+, HER2+", false = "ER/PR+"),
                                  false = if_else(condition = HER2_Subtype == "Positive", true = "HER2+", false = "TNBC"))) %>% 
    mutate(TNBC_status = if_else(Clin_Subtype == "TNBC", "TNBC", "RPBC"))

TCGA_subs <- TCGAquery_subtype(tumor = "brca") #easily get TCGA PAM50 status this way

BRCA_pam50 <- TCGA_subs %>% select(patient, PAM50 = BRCA_Subtype_PAM50) %>% filter(PAM50 != "NA")

BRCA_clinical <- full_join(BRCA_clinical, BRCA_pam50, by = c("bcr_patient_barcode" = "patient")) 

```

This table shows the clinical breakdown by subtype. 

```{r}
table(BRCA_clinical$Clin_Subtype)
table(BRCA_clinical$PAM50)

```

Ki-67 staining is not available in TCGA, so we cannot do the traditional Lum A and Lum B groups for the clinical subtyping of ER+ tumors. However, this doesn't impact us too much as there we are focused on TNBC which can be easily defined in our dataset.  


### Merging Predictions with clinical data
Next we need to load and format the prediction dataset, then we merge it with the clinical data we previously downloaded

```{r format predictions, include = FALSE}
load("./DataOut/2015CTRP-Models_on_TCGA_BRCA.RData")
BRCA_preds <- as_tibble(t(CTRPDrugPredictions_mat), rownames = "Patient_ID") 
BRCA_preds <- BRCA_preds %>% 
  filter(grepl(Patient_ID, pattern = "\\.01A\\.|\\.01B\\.")) %>% #remove normal or metastatic samples
  mutate(Patient_ID = gsub(x = strtrim(Patient_ID, width = 12), pattern = "\\.", replacement = "-")) %>% 
  gather(key = "Drug", value = "PSS", -Patient_ID) %>% #turns the table into a long format
  mutate(Drug = replace(Drug, Drug == "MK-1775", "AZD-1775")) #replaces MK-1775 as AZD-1775 since AZD-1775 is the more common name currently even though this is not how it is written in the database


#join with clinical information
preds.subtype <- left_join(BRCA_preds, BRCA_clinical, by = c("Patient_ID" = "bcr_patient_barcode")) %>% 
  drop_na(TNBC_status, PAM50)

```


### Tamoxifen imputated sensitivity and ER+ breast cancers
We have reported on HER2 inhibitors in HER2 positive cancers previously, we can look for another proof-of-concept by looking at which drugs associate with the ER-positive BRCA cohort. We'll do a similar test, stratify between ER+ and non-ER+ and perform a t-test between the two, and look for the compounds that associate with the ER+ subset. 


```{r ER Drugs}
###########ER and Tamoxifen Response#################

#ER and Tamoxifen stats:

ER_t.tst_preds <- preds.subtype %>% 
  group_by(Drug) %>% 
  drop_na(er_status_by_ihc) %>% 
  do(tidy(t.test(PSS~er_status_by_ihc, data = .))) %>% 
  ungroup() %>% 
  mutate(bonf_p.value = p.adjust(p.value, method = "bonferroni")) %>% 
  arrange(bonf_p.value) %>% 
  filter(estimate > 0)

head(ER_t.tst_preds)

#ER positivity associates with Imputed Tamoxifen Response, it is the 5th most significant result
```



### Identifying Compounds Predicted To Be More Effective in TNBC


To look for compounds that are more effective in TNBC vs other breast cancers (i.e. receptor positive or RPBC), we can subset the patients into their corresponding TNBC status and perform t-tests on the imputed drug data for each drug. Then we can correct for multiple test corrections. 

```{r Statistical testing}
t.tst_preds.subtype <- preds.subtype %>% 
  group_by(Drug) %>%  #group by drug so that each statistical test is performed for each drug
  do(tidy(t.test(PSS~TNBC_status, data = .))) %>% #way to perform t-tests and get the results from the t-test into a tbl format
  ungroup() %>% #need to ungroup so that when we adjust we are adjusting everything, otherwise the group is set to make each drug independent
  mutate(bonf_p.value = p.adjust(p.value, method = "bonferroni")) %>% 
  mutate(log10_p.correct = -log10(bonf_p.value)) 

#We could also look at the results via ANOVA and look for the most significantly different values between the clinical subgroups described before or the PAM50 subgroups. I'm keeping this analysis here but some of this may become supplemental.  
aov_preds.subtype <- preds.subtype %>%
  group_by(Drug) %>%
  do(tidy(aov(.$PSS ~ .$PAM50))) %>%
  ungroup() %>% 
  filter(term == ".$PAM50") %>%
  mutate(bonf_p.value = p.adjust(p.value, method = "bonferroni"))

clin_aov_preds.subtype <- preds.subtype %>%
  group_by(Drug) %>%
  do(tidy(aov(.$PSS ~ .$Clin_Subtype))) %>%
  ungroup() %>% 
  filter(term == ".$Clin_Subtype") %>%
  mutate(bonf_p.value = p.adjust(p.value, method = "bonferroni"))



```


As a note: 
Based on t-tests, even with a bonferroni correction, most of the values are statistically signifcant. From this table `r sum(t.tst_preds.subtype$bonf_p.value < 0.00001/length(unique(t.tst_preds.subtype$Drug)), na.rm = TRUE)`% are statistically significant at a corrected p-value of 0.00001 out of the `r length(unique(t.tst_preds.subtype$Drug))`total drugs. This does indicte that we are getting an enrichment of likely false positive results, so the best thing to do would be to just consider the most significant results, essentially placing a much higher significant cutoff threshold. This should be investigated in future analysis. 

```{r, echo= FALSE}

t.tst_preds.subtype %>% 
  ggplot() +
    geom_histogram(mapping = aes(x = log10_p.correct)) +
    geom_vline(xintercept = -log10(0.00001), color = "red") +
    labs(title = "Histogram of T-test Results by Signifcance", 
         x = "Number of Drugs", 
         y = "-log10(bonferroni-adjusted p-value)")

```

Now we can create a volcano plot with the t-test results and look for the most significant results: 

```{r volcano plot of Estimate vs p-value}

t.tst_preds.subtype %>% 
  arrange(desc(log10_p.correct)) %>% 
  dplyr::slice(1:3) %>% 
  ggplot(mapping = aes(x = estimate, y = log10_p.correct, label = Drug)) + 
    geom_point(data = t.tst_preds.subtype) +
    geom_point(color = "red", size = 2.2) + 
    geom_text_repel(nudge_y = 3) + 
    labs(title = "Volcano Plot of TNBC vs RPBC T-Test Results \n P-values and Estimate Scores for All Drugs", 
         y = "-log10(p.value)", 
         x = "Mean Difference (Imputed Effect RPBC - TNBC)", 
         caption = "Drugs More Effective in RPBC                                                                                                            Drugs More Effective in TNBC") + 
    theme(plot.title = element_text(hjust = 0.5))
    
```

Highlighted in red are the 3-most significant results. Due to toxicity reasons, we chose not to look at AZD7762 or leptomycin B. AZD-1775 has some evidence that suggests its use in TNBC, although not robust, and it is the third most significant result and has a good toxicity profile already. Additionally, our first analysis looked at ANOVA results in the PAM50 subtype and AZD-1775 definitely associated with the Basal PAM50 subtype (Basal is essentially TNBC, but there are some differences especially with the LAR TNBC subtype, but overall basal roughly corresponds with TNBC). But we can look at the top drugs that associate with TNBC by effect size and p-value. 

## Top TNBC Associated Drugs 

We want to look drugs that are imputed to be more effective, more selective for TNBC by both effect size and p-value cutoffs. As mentioned earlier, we do see many drugs that are significant at the p < 0.05 cut-off. Thus we will look at effect size as well and use compounds in the top 10% in terms of effect size and significance.

We will use the review co-authored by Alex Ling and myself (Robert F. Gruener) to obtain drug target and pathway information on. 

```{r drug targets}

drug_targets <- read_csv("./Included_Data/Drug_targets(review).csv") # From Ling and Gruener et al

targets_t.test <-  t.tst_preds.subtype %>%
  mutate(Drug = replace(Drug, Drug == "AZD-1775", "MK-1775")) %>% #replacng MK1775 for AZD1775 since it will be easier to match using "Name in Database" instead of all names
  select(Drug, estimate, bonf_p.value, log10_p.correct) %>% 
  left_join(., drug_targets, by = c("Drug" = "Name in Database")) %>% 
  select(-Database) %>% 
  distinct() %>% 
  mutate(Drug = replace(Drug, Drug == "MK-1775", "AZD-1775")) %>% 
  arrange(bonf_p.value)

#there are a couple of issues. First there are combinations that are tested, and these are difficult to attribute a MOA to, so for simplicity I will remove these. 

targets_t.test <- targets_t.test[!grepl(x = targets_t.test$Drug, pattern = "mol/mol"),]

targets_t.test

```

```{r drug targets continued top drugs}

#From here I'm more concerned about the top compounds based on effect size and p-value 

effect_cutoff <- sort(abs(t.tst_preds.subtype$estimate), decreasing = T)[55] #there are 545 drugs, so 54 or 55 would be the top 10%
p_val_cutoff <- sort(abs(t.tst_preds.subtype$bonf_p.value), decreasing = F)[55] 

top_targets_t.tst <- targets_t.test %>% 
 filter(estimate > effect_cutoff,
         bonf_p.value < p_val_cutoff) 

# Second, several compounds are compounds that don't have any information for their MOA, but most of these do have gene targets listed. I will use the gene target information and do some quick validation (read: googling) on the compound and targets to be able to convert them into a 

missing_MOA <- top_targets_t.tst[top_targets_t.tst$MOA %in% c("0","#N/A"),]
missing_MOA

found_MOA <- vector(mode= "character", length = 9)
found_MOA <- c("Orphan Nuclear Receptor Agonist", "CDK inhibitor", "ceramidase inhibitor", "translation (eIF4F complex) inhibiitor", "Transcription factor LSF inhibitor", "HDAC Inhibitor", "RhoA inhibitor", "translation (eIF4F complex) inhibiitor", "Phosphodiesterase inhibitor")
names(found_MOA) = missing_MOA$Drug

targets_t.test$MOA[targets_t.test$Drug %in% names(found_MOA)] <- found_MOA

targets_t.test

#Note:  
  #3-Cl-AHPC: Unclear, one publication claimed that it doesn't activate RAR and works through AKT (PMID: 14981538) while a much more recent publication says that it does (PMID: 30370662), while the database claims it is an orphan nuclear receptor agonist

#Finally, I ideally want this as simple as possible but some have multiple MOA listed. I will use the first one listed as the primary one, since it will be easiest this way. For all except the PLK inhibitor, since "cell cycle inhibitor" is listed first for that one, but otherwise it seems the most specific one is listed first

#lets save the targets_t.test as a supplementary table

#the MOA column can be quite long and usually the first one is the more detailed one, so I'll jsut include that except for one change I'll make
targets_t.test$MOA[targets_t.test$MOA == "cell cycle inhibitor|PLK inhibitor"] <- "PLK inhibitor|cell cycle inhibitor"
targets_t.test$MOA <- gsub(pattern = "\\|.*$", replacement = "", x = targets_t.test$MOA)


targets_t.test %>% 
  select(Drug, "Pubchem ID" = `Harmonized ID (Pubchem ID)`, "Effect Size" = estimate, "Bonferroni Adjusted p-value" = bonf_p.value, 
         MOA, Targets, `Clinical Phase`, `Source for Clinical Information`) %>% 
  write_csv(., path = "./DataOut/Supplementary Table 1")

#I'll make a table for the actual text in excel using the Supplementary data and some filters, but here is roughly what I'll be looking for:

#here is roughly how the table will look using the top 5% 

effect_cutoff <- sort(abs(t.tst_preds.subtype$estimate), decreasing = T)[29] 
p_val_cutoff <- sort(abs(t.tst_preds.subtype$bonf_p.value), decreasing = F)[28]

targets_t.test %>% filter(estimate > effect_cutoff,
         bonf_p.value < p_val_cutoff) %>% count(MOA, sort = T)

#here is how the the table would look with a top 10% 

effect_cutoff <- sort(abs(t.tst_preds.subtype$estimate), decreasing = T)[55] 
p_val_cutoff <- sort(abs(t.tst_preds.subtype$bonf_p.value), decreasing = F)[55]

targets_t.test %>% filter(estimate > effect_cutoff,
         bonf_p.value < p_val_cutoff) %>% count(MOA, sort = T)



```


A different analysis looked at eta.sq values and the used the most significant hits that have an effect size at least as great as taxomifen in ER+ cancers. Here is the list of drugs (with one drug combo) that fits this criteria


### Graphing results in BRCA subtypes 

We can look how certain drugs are 

```{r graphing function 1}

library(ggpubr) #ggpubr has some nice default settings for adding comparisons
library(ggplot2)


Sensitivity_grapher <- function(drug, comparison, group = "TNBC"){
test <- combn(unique(eval(parse(text = paste("preds.subtype$", comparison)))), 2) #get all the comparisons
test_list <- split(test, rep(1:ncol(test), each = nrow(test)))
comp_list <- test_list[grepl(pattern = group, test_list)] #get all the comparisons between the group and TNBC (or group)

box_labs <- preds.subtype %>%  #placing the number of patients in each subtype into the boxes
    filter(Drug == drug) %>% 
    count_(comparison) %>% 
    .$n

print(                       #graphing function that graphs boxplots with comparisons 
  preds.subtype %>% 
    filter(Drug == drug) %>% 
    arrange_(comparison) %>% 
  ggboxplot(x = comparison, y = "PSS", fill = comparison) +
      labs(title = paste(drug, "'s Imputed Sensitivity in TCGA BRCA Cohort by Receptor Status", sep = ""),
           y = "Imputed Sensitivity Score", 
           x = "BRCA Clinical Subtype") +
      theme(legend.position = "none",
            plot.title = element_text(hjust = 0.5))+
    stat_compare_means(comparisons = comp_list) + 
    grids() + 
    stat_summary(geom = "text", label = paste("n =", box_labs), vjust = -0.5)
      
)
  
}

#now use this graphing function to graph AZD-1775's response in different BRCA subtypes
Sensitivity_grapher(drug = "AZD-1775", comparison = "Clin_Subtype")
Sensitivity_grapher(drug = "AZD-1775", comparison = "PAM50", group = "Basal") + 
  labs(title = "AZD-1775's Imputed Sensitivity in TCGA BRCA Cohort by PAM50 Status", 
       x = "PAM50 Subtype") #need to change the titles and axis when I change groups, may need to change that in the future

#can also look at lapatinib and tamoxifen 
Sensitivity_grapher(drug = "lapatinib", comparison = "Clin_Subtype", group = "HER2+")
Sensitivity_grapher(drug = "tamoxifen", comparison = "Clin_Subtype", group = "ER/PR+") +
    labs(title = "Tamoxifen's Imputed Sensitivity in TCGA BRCA Cohort by Receptor Status")

Sensitivity_grapher(drug = "tamoxifen", comparison = "PAM50", group = "Lum")

```




```{r graphing_function2}

#made a second graphing function to allow for a little more flexibility 
plot_sensitivity2 <- function(.data, .drug, .grp = "Clin_Subtype", .ref.group = "TNBC"){
  
  #filter
  .data <- filter(.data, Drug == .drug) %>% arrange_(.grp)
  # Compute p-values
  comparison.formula <- paste0("PSS", "~", .grp) %>%
    as.formula()
  pvalues <- compare_means(
    comparison.formula,  data = .data,
    method = "t.test", ref.group = .ref.group
    )
  # P-value y coordinates
  y.max <- .data %>% 
    pull("PSS") %>% max(na.rm = TRUE) 
  
  y.min <- .data %>% 
    pull("PSS") %>% min(na.rm = TRUE)
  
  # p.value.y.coord <- rep(y.max, nrow(pvalues)) 
  # 
  # step.increase <- (1:nrow(pvalues))*(y.max/75)
  # p.value.y.coord <- p.value.y.coord + step.increase #this is what the above graphing function does already
  
  p.value.y.coord <- .data %>%  group_by_(eval(.grp)) %>% summarize(max_pss = max(PSS)) %>% filter(.[,1] != eval(.ref.group)) %>% pull("max_pss") #this actually overwrites the above value to get the coordinates so they don't stack on top above the maximimum point but each group's maximum point
  
  step.increase <- (y.max - y.min)/20
  
  p.value.y.coord <- p.value.y.coord + step.increase

  
  pvalues <- pvalues %>%
    mutate(y.coord =  p.value.y.coord)
  
  box_labs <- preds.subtype %>% 
    filter(Drug == .drug) %>% 
    count_(.grp) %>% 
    .$n
  
  ggboxplot(.data, x = .grp, y = "PSS", fill = .grp)+
    ggsignif::geom_signif(
      data = pvalues, 
      aes(xmin = group1, xmax = group2, annotations = p.format, y_position = y.coord), #to print the full p-values, set annotations to p.adj, to get it fomatted use p.format, to get stars use p.signif  
      manual= TRUE, tip_length = 0.03, size = 0.4) + 
    grids() + 
    labs(x = "Clinical Subtype", 
         y = "Imputed Sensitivity Score", 
         title = paste(.drug, "'s Imputed Sensitivity in TCGA BRCA Cohort by Receptor Status", sep = "")) + 
    theme(legend.position = "none",
            plot.title = element_text(hjust = 0.5)) + 
    stat_summary(geom = "text", label = paste("n =", box_labs), vjust = -0.5)
}


# Graph
plot_sensitivity2(.data = preds.subtype, .drug = "AZD-1775" , .grp = "Clin_Subtype", .ref.group = "TNBC")
plot_sensitivity2(.data = preds.subtype, .drug = "AZD-1775" , .grp = "PAM50", .ref.group = "Basal") + 
    labs(x = "PAM50 Subtype")

plot_sensitivity2(.data = preds.subtype, .drug = "tamoxifen" , .grp = "Clin_Subtype", .ref.group = "ER/PR+")
plot_sensitivity2(.data = preds.subtype, .drug = "tamoxifen" , .grp = "PAM50", .ref.group = "LumA") + 
  labs(title = "Tamoxifen's Imputed Sensitivity in TCGA BRCA Cohort by PAM50 Status", 
       x = "PAM50 Subtype")


```



